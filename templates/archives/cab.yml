# STATUS: 25%

# - HI: fix CFDATA area tagging

# SAMPLE: need with "Header.Flags.Reserve present" set
# SAMPLE: need with "self.cbCFHeader" > 0
# SAMPLE: need with "self.Flags.Prev cabinet" set
# SAMPLE: need with "self.Flags.Next cabinet" set

references:
  - https://en.wikipedia.org/wiki/Cabinet_(file_format)
  - https://www.sweetscape.com/010editor/repository/files/CAB.bt
  - https://github.com/martinlindhe/formats/blob/master/parse/archive/arc_cab.go

kind: archive
extensions: [.cab]
mime: application/vnd.ms-cab-compressed
endian: little

types:
  CFDATA:
    # XXX
    u32 csum: ??
    u16 cbData: ??
    u16 cbUncomp: ??
    ascii[16] ab: ??

structs:
  header:
    ascii[4] Signature: c'MSCF'
    u32 Reserved 1: 00 00 00 00
    u32 File size: ??
    u32 Reserved 2: 00 00 00 00
    u32 CFFILE offset: ??
    u32 Reserved 3: 00 00 00 00
    u8 Minor version: ??
    u8 Major version: ??
    u16 cFolders: ??
    u16 cFiles: ??
    u16 Flags:
      bit b00000000_00000001: Prev cabinet
      bit b00000000_00000010: Next cabinet
      bit b00000000_00000100: Reserve present
    u16 Set ID: ??
    u16 Cabinet number: ??

    if self.Flags.Reserve present:
      u16 cbCFHeader: ??  # size of per-cabinet reserved area
      u8 cbCFFolder: ??   # size of per-folder reserved area
      u8 cbCFData: ??     # size of per-datablock reserved area
      u8[self.cbCFHeader] abReserve: ??  # per-cabinet reserved area

    if self.Flags.Prev cabinet:
      u8[1] szCabinetPrev: ??  # XXX length? name of previous cabinet file
      u8[1] szDiskPrev: ??     # XXX length? name of previous disk

    if self.Flags.Next cabinet:
      u8[1] szCabinetNext: ??  # XXX length? name of next cabinet file
      u8[1] szDiskNext: ??     # XXX length? name of next disk

  CFFOLDER:
    u32 Offset of first CFDATA block: ??
    u16 CFDATA blocks: ??
    u16 Compression type: ?? # XXX map meaning

    # XXX tag up CFDATA areas


  CFFILE:
    u32 uncompressed size: ??
    u32 uncompressed offset in folder: ??
    u16 index in CFFOLDER: ??
    dosdate Date: ??
    dostime Time: ??
    u16 Attributes: ?? # XXX format?

    asciiz Name: ??
  
layout:
  - header Header
  - CFFOLDER[Header.cFolders] CFFOLDER
  - CFFILE[Header.cFiles] CFFILE
#  - CFDATA CFDATA
