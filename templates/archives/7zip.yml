# STATUS: 1%

# - MAX: to progress format parse, need to handle packed u64 values as used by 7zip
# - MID: ArchiveVersion version: ?? # XXX custom types define!

references:
  - https://en.wikipedia.org/wiki/7z
  - https://github.com/kornelski/7z/blob/master/DOC/7zFormat.txt
  - https://www.sweetscape.com/010editor/repository/files/7ZIP.bt       # very rough

kind: archive
name: 7z Archive
extensions: [.7z]
mime: application/x-7z-compressed
endian: little

magic:
  - offset: 0000
    match: c'7z' bc af 27 1c

types:
  # XXX impl!!!
  ArchiveVersion:
    u8 Major: ??        # 0.3 and 0.4 is seen in 2021
    u8 Minor: ??
    format: "{0}.{1}"    # XXX impl presentation formatting string

structs:
  sig_header:
    u8[6] Signature: c'7z' bc af 27 1c

    #ArchiveVersion Version: ?? # XXX custom struct define, this should become a built-in standard type "version16" byte 0=major, byte 1=minor
    u8 Major version: ??
    u8 Minor version: ??

    # XXX impl crc32
    #crc32[NextHeaderOffset.offset:NextHeaderCRC.offset+4] StartHeaderCRC: ??
    u32 StartHeaderCRC: ??

  start_header:
    u64 NextHeaderOffset: ??
    u64 NextHeaderSize: ??
    u32 NextHeaderCRC: ??    # XXX impl crc32
    offset: self.offset + self.NextHeaderOffset

  header:
    u8 NID:
      eq 00: kEnd
      eq 01: kHeader
      eq 02: kArchiveProperties
      eq 03: kAdditionalStreamsInfo
      eq 04: kMainStreamsInfo
      eq 05: kFilesInfo
      eq 06: kPackInfo
      eq 07: kUnPackInfo
      eq 08: kSubStreamsInfo
      eq 09: kSize
      eq 0A: kCRC
      eq 0B: kFolder
      eq 0C: kCodersUnPackSize
      eq 0D: kNumUnPackStream
      eq 0E: kEmptyStream
      eq 0F: kEmptyFile
      eq 10: kAnti
      eq 11: kName
      eq 12: kCTime
      eq 13: kATime
      eq 14: kMTime
      eq 15: kWinAttributes
      eq 16: kComment
      eq 17: kEncodedHeader
      eq 18: kStartPos
      eq 19: kDummy
    label: self.NID
    #if self.NID == kHeader:
      # XXX LZMA compressed data follows?
    if self.NID == kEncodedHeader:
      # XXX
      pack_info PackInfo: ??

  pack_info:
    u8 NID: "06"  # XXX
    u64 PackPos: ??             # XXX packed u64 value ...
    #u64 PackStreamsCount: ??   # XXX packed u64 value ...
    #u64 Size: ??               # XXX packed u64 value ...

layout:
  - sig_header SignatureHeader
  - start_header StartHeader

  - header Header
