# STATUS: 25%

# - MAX: continue parsing

references:
  - https://en.wikipedia.org/wiki/7z
  - https://github.com/kornelski/7z/blob/master/DOC/7zFormat.txt
  - https://www.sweetscape.com/010editor/repository/files/7ZIP.bt       # very rough

kind: archive
name: 7z Archive
extensions: [.7z]
mime: application/x-7z-compressed
endian: little

magic:
  - offset: 0000
    match: c'7z' bc af 27 1c

structs:
  sig_header:
    u8[6] Signature: c'7z' bc af 27 1c
    u8 MajorVersion: ??
    u8 MinorVersion: ??
    u32 StartHeaderCRC: ??    #crc32[NextHeaderOffset.offset:NextHeaderCRC.offset+4] StartHeaderCRC: ??       # XXX impl crc32

  start_header:
    u64 NextHeaderOffset: ??
    u64 NextHeaderSize: ??
    u32 NextHeaderCRC: ??    # XXX impl crc32
    offset: self.offset + self.NextHeaderOffset

  header:
    u8 NID:
      eq 00: kEnd
      eq 01: kHeader
      eq 02: kArchiveProperties
      eq 03: kAdditionalStreamsInfo
      eq 04: kMainStreamsInfo
      eq 05: kFilesInfo
      eq 06: kPackInfo
      eq 07: kUnPackInfo
      eq 08: kSubStreamsInfo
      eq 09: kSize
      eq 0A: kCRC
      eq 0B: kFolder
      eq 0C: kCodersUnPackSize
      eq 0D: kNumUnPackStream
      eq 0E: kEmptyStream
      eq 0F: kEmptyFile
      eq 10: kAnti
      eq 11: kName
      eq 12: kCTime
      eq 13: kATime
      eq 14: kMTime
      eq 15: kWinAttributes
      eq 16: kComment
      eq 17: kEncodedHeader
      eq 18: kStartPos
      eq 19: kDummy
    label: self.NID
    if self.NID == kHeader:
      # XXX LZMA compressed data follows?
      nid_block kHeader: ??
    if self.NID == kEncodedHeader:
      nid_block PackInfo: ??


  nid_block:
    u8 NID:
      eq 00: kEnd
      eq 01: kHeader
      eq 06: kPackInfo
      eq 09: kSize
    if self.NID == kEnd:
      parse: stop
    if self.NID == kHeader:
      # XXX ArchiveProperties follows
      u8 ArchivePropertiesXXX: ??
    if self.NID == kPackInfo:
      vu64 PackPos: ??
      vu64 PackStreamsCount: ??
      nid_block[self.PackStreamsCount] Size: ??
      nid_block Terminator: ??
      if self.Terminator.NID != kEnd:
        data: invalid
    if self.NID == kSize:
      vu64 Size: ??

layout:
  - sig_header SignatureHeader
  - start_header StartHeader
  - header Header
