# STATUS: 1%
# - HI: block syntax

references:
  - https://git.tukaani.org/?p=xz.git;a=blob_plain;f=doc/xz-file-format.txt;hb=HEAD
  - https://github.com/martinlindhe/formats/blob/master/parse/archive/arc_xz.go

kind: archive
extensions: [.xz]
mime: application/x-xz
endian: big # XXX

structs:
  header:
    # stream header. valid xz contains 1 or more streams with header+data
    u8[6] Signature: FD c'7zXZ' 00
    u16 Stream flags:
      eq 0000: None
      eq 0001: CRC32    # XXX 4 bytes
      eq 0004: CRC64     # XXX 8 bytes
      eq 000a: SHA-256    # XXX 32 bytes
      default: invalid

    # XXX calculated over Reserved+Stream flags (2 bytes)
    u32 CRC32: ?? # XXX seems header always has a crc32, the Stream flags checksum is used elsewhere ???


    # XXX BLOCK HEADER:

    u8 Block header size: ??    # real_header_size = (encoded_header_size + 1) * 4;
    u8 Block flags:
      bit b0000_0011: Number of filters
      bit b0011_1100: Reserved
      bit b0100_0000: Compressed Size field present
      bit b1000_0000: Uncompressed Size field present

    #if Block flags[Compressed Size field present]:
    #  XXX variable-length integer encoding, see decode() in https://git.tukaani.org/?p=xz.git;a=blob_plain;f=doc/xz-file-format.txt;hb=HEAD

    #if Block flags[Uncompressed Size field present]:
    #  XXX variable-length integer encoding, see decode() in https://git.tukaani.org/?p=xz.git;a=blob_plain;f=doc/xz-file-format.txt;hb=HEAD

    # XXX variable number of filter blocks
    #for Block flags.Number of filters:      # XXX FOR-LOOP
    #  type-xxx Filter ID: ?? # variable-length encoding specific for xz format
    #  type-xxx Size of properties: ?? # variable-length encoding specific for xz format
    #  type-some Filter properties: ?? # XXX


    # XXX HEADER PADDING: This field contains as many null byte as it is needed to make the Block Header have the size specified in Block Header Size.

    u32 CRC32: ?? # XXX ?!

    u8[2] Compressed data: ?? # XXX size ???


    # STREAM FOOTER (0x0C bytes):
    #u32 CRC32: ??
    #u32 Backward size: ?? # XXX
    #u16 Stream flags: ??  # XXX MIRROR OF above stream flags !
    #ascii[2] Footer signature: c'YZ'

layout:
  - header Header
