# STATUS: 50% (overlaps optional palette on image data area. need ELSE and single-line-multi-IF syntax to fix)

# - HI: allow complex "if" expression with multiple checks. allow "ELSE" block (needed for proper mapping of palette)

# - HI: map image palette (need sample!)
# - HI: NEED custom type "rgb" (for palette)

references:
  - http://web.archive.org/web/20100206055706/http://www.qzx.com/pc-gpe/pcx.txt
  - https://www.sweetscape.com/010editor/repository/files/PCX.bt

kind: image
extensions: [.pcx]
mime: image/x-pcx
endian: little

structs:
  header:
    u8 Signature: 0a
    u8 Version:
      eq 00: PC Paintbrush 2.5 + fixed EGA palette
      eq 02: PC Paintbrush 2.8 + modifiable EGA palette
      eq 03: PC Paintbrush 2.8 + no palette
      eq 04: PC Paintbrush for Windows
      eq 05: PC Paintbrush 3.0, including 24-bit images
      default: invalid
    u8 Encoding:
      eq 00: None
      eq 01: RLE
      default: invalid
    u8 Bits per pixel:
      eq 01: 1bpp (monochrome)
      eq 02: 2bpp (4 colors)
      eq 04: 4bpp (16 colors, EGA)
      eq 08: 8bpp (256 colors, VGA)
      default: invalid
    u16 Minimum X position: ??
    u16 Minimum Y position: ??
    u16 Maximum X position: ??
    u16 Maximum Y position: ??
    u16 Horizontal resolution in DPI: ??
    u16 Vertical resolution in DPI: ??
    u8[48] EGA palette: ??
    u8 Reserved: ??
    u8 Color planes: ??
    u16 Bytes per line: ??
    u16 Palette mode:
      eq 0001: Monochrome or color
      eq 0002: Grayscale
      default: invalid
    u16 Horizontal resolution: ??
    u16 Vertical resolution: ??
    u8[54] Reserved: ??

    # TODO need "else" in order to not overlap palette on image data area
    u8[FILE_SIZE - self.offset] Image data: ??

    # TEST WITH: ..\formats\samples\image\pcx\rgb8_with_palette.pcx
    # XXX syntax:    if in(self.Version, (3,4,5)) && in(xxx)      XXXX add built-in in() function
    if self.Version in (3,4,5):  # TODO multiple IF in one line
      if self.Bits per pixel in (8):
        if self.Color planes in (1):
          u8[FILE_SIZE - 769:1] Palette marker: "0c"
          # XXX 256 "rgb" (u8 r,g,b) pairs. NEED custom type "rgb"
          u8[FILE_SIZE - 768:768] Palette: ??

layout:
  - header Header
