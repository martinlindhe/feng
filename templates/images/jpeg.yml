# STATUS: 30%

# - HI: figure out how to decode image data stream (between SOI and EOI markers)
# - HI: file is a stream of packets with different signature. parse until EOF
# - MID: use custom types

references:
  - https://en.wikipedia.org/wiki/JPEG
  - https://en.wikipedia.org/wiki/JPEG_File_Interchange_Format
  - https://www.sweetscape.com/010editor/repository/files/JPG.bt
  - https://github.com/HexFiend/HexFiend/blob/master/templates/Images/JPEG.tcl
  - https://github.com/martinlindhe/formats/blob/master/parse/image/img_jpeg.go

kind: image
extensions: [.jpg, .jpeg]
mime: image/jpeg

constants:
  u8[5] JFIF_APP0: c'JFIF' 00
  u8[5] JFXX_APP0: c'JFXX' 00

  u8[2] M_APP0: ff e0
  u8[2] M_APP1: ff e1
  u8[2] M_COMM: ff fe
  u8[2] M_DQT:  ff db
  u8[2] M_DHT:  ff c4
  u8[2] M_SOS:  ff da
  u8[2] M_SOF0: ff c0
  u8[2] M_SOF2: ff c2
  u8[2] M_EOI:  ff d9

types:
  # XXX MAKE USE OF
  COMPS:
    u8 compId: ??
    u8 Flag:
      bit b1111_0000: Horz
      bit b0000_1111: Vert
    u8 compNr: ??

  COMPSOS:
    u8 compId: ??
    u8 Flag:
      bit b1111_0000: DC
      bit b0000_1111: AC

structs:
  header:
    endian: big
    u8[2] SOI marker: ff d8

  segment:
    u8[2] Signature: ??
    u16 Length: ??  # length of segment excluding signature

    if self.Signature in (M_APP0):
      label: "APP0"
      ascii[5] Identifier: ??

      if self.Identifier notin (JFIF_APP0, JFXX_APP0):
        u8[Length] Unknown data: ?? # XXX verify this Length

      if self.Identifier in (JFIF_APP0):
        u8 Major version: ??
        u8 Minor version: ??
        u8 Density units:
          eq 00: No units
          eq 01: Pixels per inch
          eq 02: Pixels per centimeter
        u16 Xdensity: ??
        u16 Ydensity: ??
        u8 Xthumbnail: ??
        u8 Ythumbnail: ??
        #if Xthumbnail != 0 && Ythumbnail != 0: # XXX ?! if form ...
        #  rgb8[Xthumbnail * Ythumbnail * 3] Thumbnail data: ?? # XXX 8 bit per channel rgb: R, G, B bytes

      if self.Identifier in (JFXX_APP0):
        u8 Thumbnail format:
          eq 10: JPEG format
          eq 11: 1bpp palettized format
          eq 13: 3bpp RGB format
        u8[10] Thumbnail data: ?? # XXX size depends on Thumbnail format, see tagApp0 in https://www.sweetscape.com/010editor/repository/files/JPG.bt

    if self.Signature in (M_APP1):
      label: "APP1"
      ascii[6] EXIF: c'Exif' 00 00 # XXX
      ascii[2] Align: ??
      if Align in (c'II'):
        endian: little      # XXX what is big endian marker?
      u16 tagMark: ??
      u32 offsetFirstIFD: ?? # XXX
      # XXX WHAT FOLLOWS IS A LIST OF SECTIONS ...

    if self.Signature in (M_COMM):
      label: "COMM"
      ascii[self.Length - 2] Comment: ??

    if self.Signature in (M_DQT):
      label: "DQT"
      u8 QuanFlag:
        bit b1111_0000: Pq
        bit b0000_1111: Tq
      #if self.QuanFlag.Pq == 0:  # XXX does not seem to eval ?!?!?!   because QuanFlag fields was never mapped up, because eval code is not fully recursive
      u8[64] qTable: ??
      #if !(self.QuanFlag.Pq == 0):    # XXX does not seem to eval ?!?!?!
      #  u16[64] qTable: ??

    if self.Signature in (M_DHT):
      label: "DHT"
      u8 htInfo: ??
      u8[16] htLength: ??
      u8[self.Length - 2 - 1 - 16] HTV: ??

    if self.Signature in (M_SOS):
      label: "SOS"
      u8 nr_comp: ??
      u8[2 * self.nr_comp] COMPSOS data: ?? # XXX nr_comp number of COMPSOS structs. XXX make COMPSOS a types
      u8 Ss: ??
      u8 Se: ??
      u8 Flag:
        bit b1111_0000: Ah
        bit b0000_1111: Al

      # XXX NOW WE MUST HAVE CATCH ALL UNKNOWN DATA UP-UNTIL-BUT-EXCLUDING TERMINATOR SYNTAX
      # XXX REQUIRED FOR PROPER chunk syntax for jpeg format
      #u8[until(M_EOI)] scanData: ??
      #u8[until("ff d9")] scanData: ??    # XXX FF D9 is jpeg EOI marker      
      #u8[6292] scanData: ??   # XXX matches jpeg_001.jpg
      #u8[2] EOI signature: ff d9

    if self.Signature in (M_SOF0):
      label: "SOF0"
      u8 Precision: ??
      u16 Image height: ??
      u16 Image width: ??
      u8 nr_comp: ??
      u8[3 * self.nr_comp] COMPS data: ?? # XXX nr_comp number of COMPS structs. XXX make COMPS a types

    if self.Signature in (M_SOF2):
      label: "SOF2"
      u8 Precision: ??
      u16 Image height: ??
      u16 Image width: ??
      u8 nr_comp: ??
      u8[3 * self.nr_comp] COMPS data: ?? # XXX nr_comp number of COMPS structs. XXX make COMPS a types

    if self.Signature notin (M_APP0, M_APP1, M_COMM, M_DHT, M_DQT, M_SOS, M_SOF0, M_SOF2):
      u8[self.Length - 2] Data: ??

layout:
  - header Header
  - segment[] Segment
