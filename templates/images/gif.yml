# STATUS: 20%

# - MAX: "data_sub_block[] Image data: ??" with custom type and "data: eos" marker to end slice stream
#     needed to fully parse gif format

# - MID: need to use custom "rgb" type as defined

references:
  - https://www.w3.org/Graphics/GIF/spec-gif89a.txt
  - https://en.wikipedia.org/wiki/GIF
  - https://www.sweetscape.com/010editor/repository/files/GIF.bt
  - https://github.com/HexFiend/HexFiend/blob/master/templates/Images/GIF.tcl
  - https://github.com/martinlindhe/formats/blob/master/parse/image/img_gif.go

kind: image
extensions: [.gif]
mime: image/gif
endian: little

magic:
  - offset: 0000
    match: c'GIF8'

# XXX implement custom types!
types:
  rgb:
    u8 R: ??
    u8 G: ??
    u8 B: ??

structs:
  header:
    ascii[4] Signature: c'GIF8'
    u16 Version: # TODO pattern match on ascii[2], u8[2]
      eq 6137: GIF87a
      eq 6139: GIF89a
      default: invalid

  logical_screen_descriptor:
    u16 Logical screen width: ??
    u16 Logical screen height: ??
    u8 ScreenDescriptor:
      bit b0000_0111: GlobalColorTableSize
      bit b0000_1000: Sort
      bit b0111_0000: ColorResolution
      bit b1000_0000: GlobalColorTablePresent
    u8 Background color: ??
    u8 Aspect ratio: ??

    if self.ScreenDescriptor & GlobalColorTablePresent:
      # FIXME use rgb type. rgb struct is 3 bytes. 4 fields = 12 bytes
      u8[3 * (2 << (self.ScreenDescriptor & 7))] Global color table: ??

  # XXX need to be able to evaluate this custom struct from "block" struct. XXX or as a type?
  data_block:
    u8 DataSize: ??
    u8[self.DataSize] Data: ??
    if self.DataSize == 1:
      parse: stop       # XXX mark end of slice parsing, not the whole file
      #data: eos  # FIXME TODO - XXX marks end of stream

  block:
    u8 BlockType:
      eq 2c: BLOCK_IMAGE      # image descriptor
      eq 21: BLOCK_EXTENSION
      eq 3b: BLOCK_TRAILER

    label: self.BlockType

    if self.BlockType == BLOCK_EXTENSION:
      u8 ExtensionType:
        #eq 01: EXT_PLAIN_TEXT
        eq f9: EXT_GRAPHIC_CONTROL
        #eq fe: EXT_COMMENT
        #eq ff: EXT_APPLICATION
      if self.ExtensionType == EXT_GRAPHIC_CONTROL:
        label: self.ExtensionType
        u8 Size: "04"                       # NOTE: should always be 04
        u8 Flags:
          bit b0000_0001: Transparent color
          bit b0000_0010: User input
          bit b0001_1100: Disposal method
          bit b1110_0000: Reserved
        u16 Delay time: ??
        u8 Transparent color index: ??
        u8 Block terminator: "00"

    if self.BlockType == BLOCK_IMAGE:
      u16 Left position: ??
      u16 Top position: ??
      u16 Image width: ??
      u16 Image height: ??
      u8 ImageDescriptor: # aka IMAGEDESCRIPTOR_PACKEDFIELDS
        bit b0000_0111: LocalColorTableSize
        bit b0001_1000: Reserved
        bit b0010_0000: Sort
        bit b0100_0000: Interlace
        bit b1000_0000: LocalColorTablePresent
      if self.ImageDescriptor & LocalColorTablePresent:
        # XXX RGB8 type
        u8[3 * (2 << (self.ImageDescriptor & 7))] Local color table: ??

      # IMAGEDATA starts, says 010:
      u8 LZWMinimumCodeSize: ??   # XXX meaning?

      # XXX series of data blocks. last block is one with Size==0
      # needed to parse gif_87a_002_apples.gif

      # XXX TODO IMPLEMENT THIS:
      #data_sub_block[] DataSubBlock: ??

      # XXX TODO REMOVE THIS:
      u8 DataSize: ??
      u8[self.DataSize] Data: ??
      u8 BlockTerminator: "00"

  data_sub_block:
    u8 DataSize: ??
    if self.DataSize == 0:
      parse: stop

    u8[self.DataSize] Data: ??

layout:
  - header Header
  - logical_screen_descriptor LogicalScreenDescriptor
  - block[] Block

